<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BLS/TLS Signer</title>
  <style>
    /* Signer module inherits parent theme tokens */
    .signer-module {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    
    .signer-module .panel {
      background: var(--bg-panel, #ffffff);
      border: 1px solid var(--border, #e5e7eb);
      border-radius: 1.25rem;
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
    }
    
    .signer-module .panel-title {
      font-size: 1rem;
      font-weight: 800;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .signer-module .panel-subtitle {
      font-size: 0.85rem;
      color: var(--text-dim, #64748b);
      margin-bottom: 0.75rem;
    }
    
    .signer-module .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
    }
    
    .signer-module .info-item {
      background: var(--bg-subtle, #f6f8fb);
      padding: 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid var(--border, #e5e7eb);
    }
    
    .signer-module .info-label {
      font-size: 0.75rem;
      color: var(--text-dim, #64748b);
      margin-bottom: 0.25rem;
    }
    
    .signer-module .info-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-main, #0f172a);
    }
    
    .signer-module .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.6rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid var(--border, #e5e7eb);
    }
    
    .signer-module .status-badge.online {
      background: rgba(15, 118, 110, 0.12);
      border-color: #0f766e;
      color: #0f766e;
    }
    
    .signer-module .status-badge.offline {
      background: rgba(185, 28, 28, 0.12);
      border-color: #b91c1c;
      color: #b91c1c;
    }
    
    .signer-module .status-badge.pending {
      background: rgba(245, 158, 11, 0.12);
      border-color: #d97706;
      color: #d97706;
    }
    
    .signer-module .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }
    
    .signer-module label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-dim, #64748b);
      margin-bottom: 0.35rem;
    }
    
    .signer-module input,
    .signer-module select,
    .signer-module textarea {
      width: 100%;
      background: var(--bg-subtle, #f6f8fb);
      border: 1px solid var(--border-strong, #d1d5db);
      border-radius: 1rem;
      padding: 0.75rem;
      color: var(--text-main, #0f172a);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 0.875rem;
      box-sizing: border-box;
    }
    
    .signer-module textarea {
      resize: vertical;
    }
    
    .signer-module input:focus,
    .signer-module select:focus,
    .signer-module textarea:focus {
      outline: 2px solid #008080;
      outline-offset: 2px;
    }
    
    .signer-module .output {
      background: var(--bg-subtle, #f6f8fb);
      border: 1px solid var(--border, #e5e7eb);
      border-radius: 1rem;
      padding: 0.75rem;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 0.8rem;
      white-space: pre-wrap;
      word-break: break-all;
      min-height: 60px;
      max-height: 200px;
      overflow-y: auto;
      color: var(--text-main, #0f172a);
    }
    
    .signer-module .output.success {
      border-color: #0f766e;
      background: rgba(15, 118, 110, 0.06);
    }
    
    .signer-module .output.error {
      border-color: #b91c1c;
      background: rgba(185, 28, 28, 0.06);
    }
    
    .signer-module .btn {
      appearance: none;
      border: 1px solid var(--border, #e5e7eb);
      background: #eef2f6;
      color: var(--text-main, #0f172a);
      border-radius: 9999px;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 0.55rem 0.9rem;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      transition: background 0.15s ease, transform 0.05s ease;
    }
    
    .signer-module .btn:hover {
      background: #e2e8f0;
    }
    
    .signer-module .btn:active {
      transform: translateY(1px);
    }
    
    .signer-module .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .signer-module .btn-accent {
      background: #008080;
      color: #ffffff;
      border-color: #008080;
    }
    
    .signer-module .btn-accent:hover {
      filter: saturate(110%);
    }
    
    .signer-module .btn-sm {
      font-size: 0.8rem;
      padding: 0.4rem 0.7rem;
    }
    
    .signer-module .actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
    }
    
    .signer-module .input-group {
      margin-bottom: 0.75rem;
    }
    
    .signer-module .module-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .signer-module .module-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: var(--bg-subtle, #f6f8fb);
      border: 1px solid var(--border, #e5e7eb);
      border-radius: 0.75rem;
      cursor: pointer;
      transition: border-color 0.15s;
    }
    
    .signer-module .module-item:hover {
      border-color: #008080;
    }
    
    .signer-module .module-item.selected {
      border-color: #008080;
      background: rgba(0, 128, 128, 0.06);
    }
    
    .signer-module .module-name {
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .signer-module .module-meta {
      font-size: 0.75rem;
      color: var(--text-dim, #64748b);
    }
    
    .signer-module .publisher-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .signer-module .publisher-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: var(--bg-subtle, #f6f8fb);
      border: 1px solid var(--border, #e5e7eb);
      border-radius: 0.75rem;
    }
    
    .signer-module .publisher-id {
      font-weight: 600;
      color: #008080;
    }
    
    .signer-module .publisher-algo {
      font-size: 0.75rem;
      color: var(--text-dim, #64748b);
    }
    
    .signer-module .hash-display {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 0.75rem;
      background: var(--bg-subtle, #f6f8fb);
      padding: 0.5rem;
      border-radius: 0.5rem;
      word-break: break-all;
      border: 1px solid var(--border, #e5e7eb);
    }
    
    .signer-module .step-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .signer-module .step-num {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--bg-subtle, #f6f8fb);
      border: 2px solid var(--border, #e5e7eb);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }
    
    .signer-module .step-num.active {
      background: #008080;
      border-color: #008080;
      color: white;
    }
    
    .signer-module .step-num.done {
      background: #0f766e;
      border-color: #0f766e;
      color: white;
    }
    
    @media (prefers-color-scheme: dark) {
      .signer-module .panel {
        background: #0f172a;
        border-color: #1e293b;
      }
      .signer-module .info-item,
      .signer-module .module-item,
      .signer-module .publisher-item {
        background: #0e1627;
        border-color: #1e293b;
      }
      .signer-module input,
      .signer-module select,
      .signer-module textarea,
      .signer-module .output,
      .signer-module .hash-display {
        background: #0e1627;
        border-color: #334155;
        color: #e5e7eb;
      }
      .signer-module .btn {
        background: #0e1627;
        border-color: #1e293b;
        color: #e5e7eb;
      }
      .signer-module .btn:hover {
        background: #13203a;
      }
      .signer-module .info-value,
      .signer-module .module-name {
        color: #e5e7eb;
      }
      .signer-module .step-num {
        background: #0e1627;
        border-color: #334155;
      }
    }
  </style>
</head>
<body>
  <div class="signer-module">
    <!-- Status Panel -->
    <div class="panel">
      <div class="panel-title">
        <span>üîê Module Status</span>
        <span id="statusBadge" class="status-badge offline">
          <span class="dot"></span>
          <span>Checking...</span>
        </span>
      </div>
      <div class="info-grid">
        <div class="info-item">
          <div class="info-label">Module ID</div>
          <div class="info-value">bls_tls_signer_v1</div>
        </div>
        <div class="info-item">
          <div class="info-label">Version</div>
          <div class="info-value" id="infoVersion">1.0.0</div>
        </div>
        <div class="info-item">
          <div class="info-label">Status</div>
          <div class="info-value" id="infoStatus">‚Äî</div>
        </div>
        <div class="info-item">
          <div class="info-label">Capabilities</div>
          <div class="info-value" id="infoCaps">5 caps</div>
        </div>
      </div>
    </div>

    <!-- Module Signing Card -->
    <div class="panel">
      <div class="panel-title">üìù Sign Module</div>
      <div class="panel-subtitle">Create a cryptographic signature for a module to establish trust.</div>
      
      <div class="input-group">
        <label>1. Select Module</label>
        <div id="moduleList" class="module-list">
          <div style="color: var(--text-dim, #64748b); font-size: 0.85rem;">Loading modules...</div>
        </div>
      </div>
      
      <div class="input-group">
        <label>2. Publisher</label>
        <select id="publisherSelect">
          <option value="">Select publisher...</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>3. BLS Key Handle</label>
        <input type="text" id="keyHandle" placeholder="Enter BLS key handle from Web3Signer">
      </div>
      
      <div class="actions">
        <button class="btn btn-accent" id="prepareBtn">Prepare Manifest</button>
        <button class="btn btn-accent" id="signBtn" disabled>Sign Module</button>
        <button class="btn" id="applyBtn" disabled>Apply Signature</button>
      </div>
      
      <div class="input-group">
        <label>Result</label>
        <div id="signOutput" class="output">Select a module to begin signing.</div>
      </div>
    </div>

    <!-- BLS Key Management Card -->
    <div class="panel">
      <div class="panel-title">üîë BLS Key Registration</div>
      <div class="panel-subtitle">Register a new BLS key via Web3Signer for signing operations.</div>
      
      <div class="input-group">
        <label>Key Mode</label>
        <select id="keyMode">
          <option value="persistent">Persistent (stored in Web3Signer)</option>
          <option value="ephemeral">Ephemeral (in-memory only)</option>
        </select>
      </div>
      
      <div class="actions">
        <button class="btn btn-accent" id="registerKeyBtn">Register Key</button>
      </div>
      
      <div class="input-group">
        <label>Result</label>
        <div id="keyOutput" class="output">No key registered yet.</div>
      </div>
    </div>

    <!-- Trust Configuration Card -->
    <div class="panel">
      <div class="panel-title">
        <span>üõ°Ô∏è Verified Publishers</span>
        <span id="chainBadge" class="status-badge pending">
          <span class="dot"></span>
          <span>Syncing...</span>
        </span>
      </div>
      <div class="panel-subtitle">On-chain verified publishers who can sign modules. Status is verified against blockchain state.</div>
      
      <div class="info-grid" style="margin-bottom: 0.75rem;">
        <div class="info-item">
          <div class="info-label">Chain ID</div>
          <div class="info-value" id="chainId">‚Äî</div>
        </div>
        <div class="info-item">
          <div class="info-label">Last Sync Block</div>
          <div class="info-value" id="lastSyncBlock">‚Äî</div>
        </div>
        <div class="info-item">
          <div class="info-label">Verified</div>
          <div class="info-value" id="verifiedCount">‚Äî</div>
        </div>
        <div class="info-item">
          <div class="info-label">Total</div>
          <div class="info-value" id="totalPublishers">‚Äî</div>
        </div>
      </div>
      
      <div id="publisherList" class="publisher-list">
        <div style="color: var(--text-dim, #64748b); font-size: 0.85rem;">Loading publishers from blockchain...</div>
      </div>
      
      <div class="actions" style="margin-top: 0.75rem;">
        <button class="btn btn-sm" id="refreshTrustBtn">‚Üª Sync Chain</button>
      </div>
    </div>
  </div>
  
  <script>
    (function() {
      const $ = (id) => document.getElementById(id);
      let state = {
        modules: [],
        selectedModule: null,
        preparedManifest: null,
        signedModule: null,
        publishers: []
      };
      
      async function fetchJson(url, options = {}) {
        const res = await fetch(url, {
          headers: { 'Content-Type': 'application/json' },
          ...options
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: res.statusText }));
          throw new Error(err.error || err.details || 'Request failed');
        }
        return res.json();
      }
      
      async function checkStatus() {
        const badge = $('statusBadge');
        try {
          const res = await fetch('/v1/staking/status');
          if (res.ok) {
            const data = await res.json();
            badge.className = 'status-badge online';
            badge.innerHTML = '<span class="dot"></span><span>Online</span>';
            
            const mod = data.modules?.find(m => m.id === 'bls_tls_signer_v1');
            if (mod) {
              $('infoStatus').textContent = mod.loaded ? 'loaded' : 'registered';
              $('infoCaps').textContent = (mod.capabilities || []).length + ' caps';
            }
          } else {
            throw new Error('Status check failed');
          }
        } catch (e) {
          badge.className = 'status-badge offline';
          badge.innerHTML = '<span class="dot"></span><span>Offline</span>';
          $('infoStatus').textContent = 'unreachable';
        }
      }
      
      async function loadModules() {
        const list = $('moduleList');
        try {
          const data = await fetchJson('/api/signing/modules');
          state.modules = data.modules || [];
          
          if (state.modules.length === 0) {
            list.innerHTML = '<div style="color: var(--text-dim); font-size: 0.85rem;">No modules found</div>';
            return;
          }
          
          list.innerHTML = state.modules.map(m => `
            <div class="module-item" data-id="${m.id}">
              <div>
                <div class="module-name">${m.id}</div>
                <div class="module-meta">v${m.version} ‚Ä¢ ${m.capabilities?.length || 0} caps</div>
              </div>
              <span class="status-badge ${m.trusted ? 'online' : 'pending'}">
                <span class="dot"></span>
                ${m.trusted ? 'Trusted' : 'Unsigned'}
              </span>
            </div>
          `).join('');
          
          list.querySelectorAll('.module-item').forEach(el => {
            el.addEventListener('click', () => selectModule(el.dataset.id));
          });
        } catch (e) {
          list.innerHTML = `<div style="color: #b91c1c; font-size: 0.85rem;">Error: ${e.message}</div>`;
        }
      }
      
      function selectModule(id) {
        state.selectedModule = state.modules.find(m => m.id === id);
        state.preparedManifest = null;
        state.signedModule = null;
        
        $('moduleList').querySelectorAll('.module-item').forEach(el => {
          el.classList.toggle('selected', el.dataset.id === id);
        });
        
        $('signBtn').disabled = true;
        $('applyBtn').disabled = true;
        $('signOutput').textContent = `Selected: ${id}\nClick "Prepare Manifest" to continue.`;
        $('signOutput').className = 'output';
      }
      
      async function loadTrust() {
        const list = $('publisherList');
        const select = $('publisherSelect');
        const chainBadge = $('chainBadge');
        
        try {
          const data = await fetchJson('/api/signing/trust');
          state.publishers = data.publishers || [];
          
          // Update chain info
          if (data.chain) {
            $('chainId').textContent = data.chain.chainId || '‚Äî';
            $('lastSyncBlock').textContent = data.chain.lastSyncBlock?.toLocaleString() || '‚Äî';
            chainBadge.className = data.chain.rpcConnected ? 'status-badge online' : 'status-badge pending';
            chainBadge.innerHTML = `<span class="dot"></span><span>${data.chain.rpcConnected ? 'Connected' : 'Offline'}</span>`;
          }
          
          $('verifiedCount').textContent = data.verifiedCount || 0;
          $('totalPublishers').textContent = data.totalCount || 0;
          
          if (state.publishers.length === 0) {
            list.innerHTML = '<div style="color: var(--text-dim); font-size: 0.85rem;">No publishers registered on-chain</div>';
            select.innerHTML = '<option value="">No publishers available</option>';
            return;
          }
          
          // Filter only verified publishers for the select dropdown
          const verifiedPublishers = state.publishers.filter(p => p.status === 'verified');
          
          list.innerHTML = state.publishers.map(p => {
            const statusClass = p.status === 'verified' ? 'online' : 
                               p.status === 'pending' ? 'pending' : 'offline';
            const statusText = p.status.charAt(0).toUpperCase() + p.status.slice(1);
            const stakeDisplay = p.stakeAmount ? (p.stakeAmount / 1e9).toFixed(2) + ' AVAX' : '‚Äî';
            
            return `
              <div class="publisher-item">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="publisher-id">${p.id}</span>
                    <span class="status-badge ${statusClass}">
                      <span class="dot"></span>
                      ${statusText}
                    </span>
                  </div>
                  <div class="module-meta">${p.name || p.id} ‚Ä¢ Stake: ${stakeDisplay} ‚Ä¢ Rep: ${p.reputationScore ?? '‚Äî'}</div>
                </div>
                <div style="text-align: right; font-size: 0.7rem; color: var(--text-dim);">
                  Block #${p.blockNumber?.toLocaleString() || '‚Äî'}
                </div>
              </div>
            `;
          }).join('');
          
          select.innerHTML = '<option value="">Select verified publisher...</option>' +
            verifiedPublishers.map(p => `<option value="${p.id}">${p.id} (${p.name || 'Unknown'})</option>`).join('');
        } catch (e) {
          list.innerHTML = `<div style="color: #b91c1c; font-size: 0.85rem;">Error: ${e.message}</div>`;
          chainBadge.className = 'status-badge offline';
          chainBadge.innerHTML = '<span class="dot"></span><span>Error</span>';
        }
      }
      
      async function prepareManifest() {
        if (!state.selectedModule) {
          $('signOutput').textContent = 'Please select a module first.';
          $('signOutput').className = 'output error';
          return;
        }
        
        const publisher = $('publisherSelect').value;
        if (!publisher) {
          $('signOutput').textContent = 'Please select a publisher.';
          $('signOutput').className = 'output error';
          return;
        }
        
        $('prepareBtn').disabled = true;
        $('signOutput').textContent = 'Preparing manifest...';
        $('signOutput').className = 'output';
        
        try {
          const result = await fetchJson('/api/signing/prepare', {
            method: 'POST',
            body: JSON.stringify({
              moduleId: state.selectedModule.id,
              publisherId: publisher,
              metadata: { signedBy: 'cryftee-kiosk' }
            })
          });
          
          state.preparedManifest = result;
          $('signOutput').textContent = `Manifest prepared!\n\nSigning Hash:\n${result.signingHash}\n\nEnter a BLS key handle and click "Sign Module".`;
          $('signOutput').className = 'output success';
          $('signBtn').disabled = false;
        } catch (e) {
          $('signOutput').textContent = `Error: ${e.message}`;
          $('signOutput').className = 'output error';
        } finally {
          $('prepareBtn').disabled = false;
        }
      }
      
      async function signModule() {
        if (!state.preparedManifest) return;
        
        const keyHandle = $('keyHandle').value.trim();
        if (!keyHandle) {
          $('signOutput').textContent = 'Please enter a BLS key handle.';
          $('signOutput').className = 'output error';
          return;
        }
        
        $('signBtn').disabled = true;
        $('signOutput').textContent = 'Signing...';
        
        try {
          const result = await fetchJson('/api/signing/sign', {
            method: 'POST',
            body: JSON.stringify({
              manifest: state.preparedManifest.manifest,
              keyHandle: keyHandle,
              algorithm: 'bls'
            })
          });
          
          state.signedModule = result;
          $('signOutput').textContent = `Signed successfully!\n\nSignature:\n${result.signature.substring(0, 64)}...\n\nClick "Apply Signature" to update the manifest.`;
          $('signOutput').className = 'output success';
          $('applyBtn').disabled = false;
        } catch (e) {
          $('signOutput').textContent = `Signing failed: ${e.message}`;
          $('signOutput').className = 'output error';
          $('signBtn').disabled = false;
        }
      }
      
      async function applySignature() {
        if (!state.signedModule) return;
        
        $('applyBtn').disabled = true;
        $('signOutput').textContent = 'Applying signature to manifest...';
        
        try {
          await fetchJson('/api/signing/apply', {
            method: 'POST',
            body: JSON.stringify(state.signedModule)
          });
          
          $('signOutput').textContent = `‚úì Signature applied!\n\nModule "${state.signedModule.manifest.moduleId}" is now signed and trusted.`;
          $('signOutput').className = 'output success';
          
          state.selectedModule = null;
          state.preparedManifest = null;
          state.signedModule = null;
          
          await loadModules();
        } catch (e) {
          $('signOutput').textContent = `Failed to apply: ${e.message}`;
          $('signOutput').className = 'output error';
          $('applyBtn').disabled = false;
        }
      }
      
      async function registerKey() {
        const mode = $('keyMode').value;
        const output = $('keyOutput');
        const btn = $('registerKeyBtn');
        
        btn.disabled = true;
        output.textContent = 'Registering key...';
        output.className = 'output';
        
        try {
          const result = await fetchJson('/v1/staking/bls/register', {
            method: 'POST',
            body: JSON.stringify({ mode })
          });
          
          output.textContent = `‚úì Key registered!\n\nHandle: ${result.key_handle || result.keyHandle}\n\nPublic Key:\n${result.bls_pub_key_b64 || result.blsPubKeyB64}`;
          output.className = 'output success';
        } catch (e) {
          output.textContent = `Error: ${e.message}`;
          output.className = 'output error';
        } finally {
          btn.disabled = false;
        }
      }
      
      // Event listeners
      $('prepareBtn').addEventListener('click', prepareManifest);
      $('signBtn').addEventListener('click', signModule);
      $('applyBtn').addEventListener('click', applySignature);
      $('registerKeyBtn').addEventListener('click', registerKey);
      $('refreshTrustBtn').addEventListener('click', loadTrust);
      
      // Initialize
      checkStatus();
      loadModules();
      loadTrust();
      setInterval(checkStatus, 10000);
    })();
  </script>
</body>
</html>
