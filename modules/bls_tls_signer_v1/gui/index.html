<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BLS/TLS Signer</title>
  <style>
    /* Match main dashboard theme tokens */
    :root {
      --bg-main:   #ffffff;
      --bg-subtle: #f6f8fb;
      --bg-panel:  #ffffff;
      --text-main: #0f172a;
      --text-dim:  #64748b;
      --accent:     #008080;
      --accent-ink: #ffffff;
      --ok:      #0f766e;
      --warn:    #92400e;
      --bad:     #b91c1c;
      --pending: #1d4ed8;
      --border:        #e5e7eb;
      --border-strong: #d1d5db;
      --radius-xl:  1.25rem;
      --radius-lg:  1rem;
      --radius-md:  0.75rem;
      --radius-pill: 9999px;
      --pad-xl: 1.25rem;
      --pad-lg:  1rem;
      --pad-md:  0.75rem;
      --pad-sm:  0.5rem;
      --font-stack: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-sm: 0 4px 12px rgba(15, 23, 42, 0.08);
      --code-bg:  #0b1220;
      --code-ink: #e5e7eb;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-main:   #0b1220;
        --bg-subtle: #0e1627;
        --bg-panel:  #0f172a;
        --text-main: #e5e7eb;
        --text-dim:  #94a3b8;
        --border:        #1e293b;
        --border-strong: #334155;
        --shadow-xs: 0 1px 2px rgba(0,0,0,0.25);
        --shadow-sm: 0 4px 12px rgba(0,0,0,0.35);
      }
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: var(--font-stack);
      background: linear-gradient(180deg, var(--bg-subtle) 0%, var(--bg-main) 100%);
      color: var(--text-main);
      padding: var(--pad-xl);
      overflow-y: auto;
    }

    /* Cards Grid - matches .modules-grid */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: var(--pad-lg);
    }

    /* Card - matches .module-card / .panel */
    .card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--pad-md) var(--pad-xl);
      border-bottom: 1px solid var(--border);
      background: var(--bg-subtle);
    }
    .card-title {
      font-size: 1rem;
      font-weight: 800;
      color: var(--text-main);
    }
    .card-body {
      padding: var(--pad-xl);
    }

    /* Chips - matches main UI */
    .chips { display: flex; flex-wrap: wrap; gap: .5rem; }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      padding: .4rem .75rem;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border);
      background: var(--bg-panel);
      box-shadow: var(--shadow-xs);
      font-size: .85rem;
      color: var(--text-main);
    }
    .chip .dot { width: .55rem; height: .55rem; border-radius: 50%; }
    .dot.ok { background: var(--ok); }
    .dot.warn { background: var(--warn); }
    .dot.bad { background: var(--bad); }
    .dot.pending { background: var(--pending); }
    .chip.inactive { opacity: 0.6; }
    .chip-ok { background: rgba(15, 118, 110, 0.12); border-color: var(--ok); color: var(--ok); }

    /* Badge in card header */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      padding: .35rem .65rem;
      border-radius: var(--radius-pill);
      font-size: .8rem;
      font-weight: 600;
      border: 1px solid var(--border);
      background: var(--bg-panel);
    }
    .badge .dot { width: .5rem; height: .5rem; border-radius: 50%; }
    .badge.ok { background: rgba(15, 118, 110, 0.12); border-color: var(--ok); color: var(--ok); }
    .badge.warn { background: rgba(146, 64, 14, 0.12); border-color: var(--warn); color: var(--warn); }
    .badge.bad { background: rgba(185, 28, 28, 0.12); border-color: var(--bad); color: var(--bad); }

    /* Info grid - matches .module-meta */
    .info-grid {
      display: flex;
      gap: var(--pad-lg);
      flex-wrap: wrap;
    }
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .info-label {
      color: var(--text-dim);
      font-size: 0.75rem;
    }
    .info-value {
      color: var(--text-main);
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Forms */
    label {
      font-size: 0.85rem;
      color: var(--text-dim);
      display: block;
      margin-bottom: 4px;
    }
    input, select, textarea {
      width: 100%;
      background: var(--bg-subtle);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-lg);
      padding: var(--pad-md);
      color: var(--text-main);
      font-size: 0.9rem;
      font-family: inherit;
      margin-bottom: var(--pad-md);
      box-shadow: var(--shadow-xs);
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    textarea {
      min-height: 80px;
      resize: vertical;
      font-family: var(--font-mono);
      font-size: 0.85rem;
    }
    @media (prefers-color-scheme: dark) {
      input, select, textarea { background: #0e1627; }
    }

    /* Buttons - matches .btn, .btn-soft */
    .btn {
      appearance: none;
      border: none;
      cursor: pointer;
      font-weight: 800;
      background: #eef2f6;
      border: 1px solid var(--border);
      color: var(--text-main);
      border-radius: var(--radius-pill);
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
      box-shadow: var(--shadow-xs);
      transition: background .15s ease, border-color .15s ease;
    }
    .btn:hover { filter: brightness(0.98); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    @media (prefers-color-scheme: dark) {
      .btn { background: #0e1627; }
    }
    .btn-accent {
      background: var(--accent);
      color: var(--accent-ink);
      border-color: var(--accent);
    }
    .btn-accent:hover { filter: saturate(110%); }
    .btn-row {
      display: flex;
      gap: var(--pad-sm);
      flex-wrap: wrap;
    }

    /* Output - matches .code-block style */
    .output {
      background: var(--code-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--pad-lg);
      font-family: var(--font-mono);
      font-size: 0.8rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 150px;
      overflow-y: auto;
      color: var(--code-ink);
    }
    .output.success { color: #4ade80; }
    .output.error { color: #f87171; }

    /* Trust stats - matches module-meta style */
    .trust-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--pad-md);
      margin-bottom: var(--pad-lg);
    }
    .trust-stat {
      text-align: center;
      padding: var(--pad-md);
      background: var(--bg-subtle);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
    }
    .trust-stat .value {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--accent);
    }
    .trust-stat .label {
      font-size: 0.7rem;
      color: var(--text-dim);
      text-transform: uppercase;
      margin-top: 2px;
    }

    /* Publisher list */
    .publisher-list {
      max-height: 140px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--bg-subtle);
    }
    .publisher-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--pad-sm) var(--pad-md);
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
    }
    .publisher-row:last-child { border-bottom: none; }
    .publisher-id {
      font-family: var(--font-mono);
      color: var(--text-main);
      font-size: 0.8rem;
    }
    .pub-status {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      font-weight: 600;
    }
    .pub-status.verified {
      background: rgba(15, 118, 110, 0.12);
      color: var(--ok);
    }
    .pub-status.pending {
      background: rgba(146, 64, 14, 0.12);
      color: var(--warn);
    }

    /* Chain badge */
    .chain-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: var(--pad-sm) var(--pad-md);
      background: rgba(0, 128, 128, 0.12);
      border: 1px solid var(--accent);
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      color: var(--accent);
      margin-bottom: var(--pad-md);
    }

    /* Section label */
    .section-label {
      font-size: 0.75rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--pad-sm);
      font-weight: 600;
    }

    @media (max-width: 640px) {
      .cards-grid { grid-template-columns: 1fr; }
      .info-grid { flex-direction: column; gap: var(--pad-sm); }
      .trust-stats { grid-template-columns: 1fr; }
    }

    /* ==================== TILE VISIBILITY SYSTEM ==================== */
    .tile-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--pad-lg);
      padding: var(--pad-sm) var(--pad-md);
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      gap: var(--pad-md);
      flex-wrap: wrap;
    }
    .tile-toolbar-info {
      display: flex;
      align-items: center;
      gap: var(--pad-sm);
      font-size: 0.85rem;
      color: var(--text-dim);
    }
    .tile-toolbar-info .hidden-count {
      font-weight: 600;
      color: var(--accent);
    }
    .tile-toolbar-actions {
      display: flex;
      gap: var(--pad-sm);
    }
    .btn-sm {
      padding: 0.4rem 0.75rem;
      font-size: 0.8rem;
    }
    
    /* Hide toggle button in card header */
    .tile-hide-btn {
      appearance: none;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: var(--radius-md);
      color: var(--text-dim);
      font-size: 0.9rem;
      transition: background 0.15s, color 0.15s;
      margin-left: auto;
      margin-right: var(--pad-sm);
    }
    .tile-hide-btn:hover {
      background: var(--bg-subtle);
      color: var(--text-main);
    }
    
    /* Hidden tile state */
    .card.tile-hidden {
      display: none;
    }
    .card.tile-minimized {
      max-height: 50px;
      overflow: hidden;
    }
    .card.tile-minimized .card-body {
      display: none;
    }
    .card.tile-minimized .tile-hide-btn::after {
      content: ' (hidden)';
      font-size: 0.75rem;
      color: var(--text-dim);
    }
    
    /* Hidden tiles list */
    .hidden-tiles-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .hidden-tile-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: rgba(0, 128, 128, 0.1);
      border: 1px solid var(--accent);
      border-radius: var(--radius-pill);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }
    .hidden-tile-chip:hover {
      background: rgba(0, 128, 128, 0.2);
      transform: scale(1.02);
    }
    .hidden-tile-chip:active {
      transform: scale(0.98);
    }
    .hidden-tile-chip .restore-icon {
      font-size: 0.7rem;
      opacity: 0.8;
    }
  </style>
</head>
<body>

  <!-- Tile Visibility Toolbar -->
  <div class="tile-toolbar" id="tile-toolbar">
    <div class="tile-toolbar-info">
      <span>üéõÔ∏è Tiles:</span>
      <div class="hidden-tiles-list" id="hidden-tiles-list"></div>
    </div>
    <div class="tile-toolbar-actions">
      <button class="btn btn-sm" id="show-all-btn" style="display:none;">Show All</button>
      <button class="btn btn-sm" id="reset-layout-btn">Reset Layout</button>
    </div>
  </div>

  <div class="cards-grid" id="cards-grid">

    <!-- Module Status Card -->
    <div class="card" data-tile-id="module-status" data-tile-name="Module Status">
      <div class="card-header">
        <span class="card-title">Module Status</span>
        <button class="tile-hide-btn" title="Hide tile">‚úï</button>
        <span id="signer-statusBadge" class="badge ok"><span class="dot ok"></span>Ready</span>
      </div>
      <div class="card-body">
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Version</span>
            <span id="signer-infoVersion" class="info-value">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Status</span>
            <span id="signer-infoStatus" class="info-value">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Capabilities</span>
            <span id="signer-infoCaps" class="info-value">‚Äî</span>
          </div>
        </div>
        <div style="margin-top: var(--pad-lg);">
          <span class="section-label">Loaded Modules</span>
          <div id="signer-moduleList" class="chips">
            <span class="chip"><span class="dot ok"></span>bls_tls_signer_v1</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Sign Message Card -->
    <div class="card" data-tile-id="sign-message" data-tile-name="Sign Message">
      <div class="card-header">
        <span class="card-title">Sign Message</span>
        <button class="tile-hide-btn" title="Hide tile">‚úï</button>
      </div>
      <div class="card-body">
        <label for="signer-publisherSelect">Publisher</label>
        <select id="signer-publisherSelect">
          <option value="">Select publisher...</option>
        </select>

        <label for="signer-keyHandle">Key Handle</label>
        <input type="text" id="signer-keyHandle" placeholder="Enter key handle or ID" />

        <label for="signer-messageInput">Message (hex or UTF-8)</label>
        <textarea id="signer-messageInput" placeholder="Enter message to sign..."></textarea>

        <div class="btn-row" style="margin-bottom: var(--pad-md);">
          <button id="signer-prepareBtn" class="btn">Prepare</button>
          <button id="signer-signBtn" class="btn btn-accent" disabled>Sign</button>
          <button id="signer-applyBtn" class="btn" disabled>Apply</button>
        </div>
        <div id="signer-signOutput" class="output">Awaiting input...</div>
      </div>
    </div>

    <!-- Key Management Card -->
    <div class="card" data-tile-id="key-management" data-tile-name="Key Management">
      <div class="card-header">
        <span class="card-title">Key Management</span>
        <button class="tile-hide-btn" title="Hide tile">‚úï</button>
      </div>
      <div class="card-body">
        <label for="signer-keyMode">Key Type</label>
        <select id="signer-keyMode">
          <option value="bls">BLS</option>
          <option value="tls">TLS</option>
        </select>

        <label for="signer-keyAction">Action</label>
        <select id="signer-keyAction">
          <option value="verify">Verify Existing Key</option>
          <option value="list">List Web3Signer Keys</option>
          <option value="generate-instructions">Generate New Key (Instructions)</option>
        </select>

        <div id="signer-verifyKeySection" style="display:none;">
          <label for="signer-verifyPubkey">Public Key (0x...)</label>
          <input type="text" id="signer-verifyPubkey" placeholder="0x..." />
        </div>

        <div class="btn-row" style="margin-bottom: var(--pad-md);">
          <button id="signer-keyActionBtn" class="btn btn-accent">Execute</button>
        </div>
        <div id="signer-keyOutput" class="output">Select an action and click Execute.</div>
      </div>
    </div>

    <!-- Module Signing Card -->
    <div class="card" data-tile-id="module-signing" data-tile-name="Module Signing">
      <div class="card-header">
        <span class="card-title">üîê Module Signing</span>
        <button class="tile-hide-btn" title="Hide tile">‚úï</button>
        <span id="signer-moduleSignBadge" class="badge"><span class="dot pending"></span>No Key</span>
      </div>
      <div class="card-body">
        <div class="section-label">Signing Key Management</div>
        <div class="info-grid" style="margin-bottom: var(--pad-lg);">
          <div class="info-item">
            <span class="info-label">Key ID</span>
            <span id="signer-moduleKeyId" class="info-value">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Key Type</span>
            <span id="signer-moduleKeyType" class="info-value">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Public Key</span>
            <span id="signer-moduleKeyPubkey" class="info-value" style="font-family: var(--font-mono); font-size: 0.75rem;">‚Äî</span>
          </div>
        </div>
        
        <div class="btn-row" style="margin-bottom: var(--pad-lg);">
          <button id="signer-genModuleKeyBtn" class="btn btn-accent">Generate Key</button>
          <button id="signer-importModuleKeyBtn" class="btn">Import Key</button>
          <button id="signer-exportModuleKeyBtn" class="btn" disabled>Export Public Key</button>
        </div>
        
        <div class="section-label">Sign WASM Module</div>
        <label for="signer-moduleWasmPath">WASM File Path or Hash</label>
        <input type="text" id="signer-moduleWasmPath" placeholder="/path/to/module.wasm or SHA256 hash" />
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--pad-md);">
          <div>
            <label for="signer-moduleId">Module ID</label>
            <input type="text" id="signer-moduleId" placeholder="my_module_v1" />
          </div>
          <div>
            <label for="signer-moduleVersion">Version</label>
            <input type="text" id="signer-moduleVersion" placeholder="1.0.0" />
          </div>
        </div>
        
        <label for="signer-publisherId">Publisher ID</label>
        <input type="text" id="signer-publisherId" placeholder="my-org" />
        
        <div class="btn-row" style="margin-bottom: var(--pad-md);">
          <button id="signer-hashModuleBtn" class="btn">Hash WASM</button>
          <button id="signer-signModuleBtn" class="btn btn-accent" disabled>Sign Module</button>
          <button id="signer-copySignatureBtn" class="btn" disabled>Copy Signature</button>
        </div>
        
        <div id="signer-moduleSignOutput" class="output">Generate or import a signing key to get started.</div>
      </div>
    </div>

    <!-- Verify Module Signature Card -->
    <div class="card" data-tile-id="verify-signature" data-tile-name="Verify Signature">
      <div class="card-header">
        <span class="card-title">‚úì Verify Module Signature</span>
        <button class="tile-hide-btn" title="Hide tile">‚úï</button>
      </div>
      <div class="card-body">
        <label for="signer-verifyWasmHash">WASM Hash (SHA256)</label>
        <input type="text" id="signer-verifyWasmHash" placeholder="64-character hex hash" />
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--pad-md);">
          <div>
            <label for="signer-verifyModuleId">Module ID</label>
            <input type="text" id="signer-verifyModuleId" placeholder="module_v1" />
          </div>
          <div>
            <label for="signer-verifyVersion">Version</label>
            <input type="text" id="signer-verifyVersion" placeholder="1.0.0" />
          </div>
        </div>
        
        <label for="signer-verifyPublisherId">Publisher ID</label>
        <input type="text" id="signer-verifyPublisherId" placeholder="publisher-id" />
        
        <label for="signer-verifyPublicKey">Publisher Public Key</label>
        <input type="text" id="signer-verifyPublicKey" placeholder="ed25519 public key (hex)" />
        
        <label for="signer-verifySignature">Signature</label>
        <textarea id="signer-verifySignature" placeholder="Hex-encoded signature" style="min-height: 60px;"></textarea>
        
        <div class="btn-row" style="margin-bottom: var(--pad-md);">
          <button id="signer-verifyModuleBtn" class="btn btn-accent">Verify Signature</button>
          <button id="signer-loadFromManifestBtn" class="btn">Load from Manifest</button>
        </div>
        
        <div id="signer-verifyModuleOutput" class="output">Enter module details and signature to verify.</div>
      </div>
    </div>

    <!-- Key Generation Guide Card -->
    <div class="card" data-tile-id="key-guide" data-tile-name="Key Guide">
      <div class="card-header">
        <span class="card-title">Key Generation Guide</span>
        <button class="tile-hide-btn" title="Hide tile">‚úï</button>
        <span class="badge"><span class="dot pending"></span>Manual</span>
      </div>
      <div class="card-body">
        <div class="section-label">Storage Backend</div>
        <select id="signer-storageBackend" style="margin-bottom: var(--pad-md);">
          <option value="file">File-based (Web3Signer default)</option>
          <option value="vault">HashiCorp Vault</option>
        </select>

        <div id="signer-guideContent">
          <!-- Dynamically populated -->
        </div>

        <div style="margin-top: var(--pad-lg);">
          <button id="signer-copyGuideBtn" class="btn">Copy Commands</button>
        </div>
      </div>
    </div>

    <!-- Trust Roots Card -->
    <div class="card" data-tile-id="trust-roots" data-tile-name="Trust Roots">
      <div class="card-header">
        <span class="card-title">Trust Roots</span>
        <button class="tile-hide-btn" title="Hide tile">‚úï</button>
      </div>
      <div class="card-body">
        <div id="signer-chainBadge" class="chain-badge">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
          </svg>
          <span>Chain: <strong id="signer-chainId">‚Äî</strong></span>
        </div>

        <div class="trust-stats">
          <div class="trust-stat">
            <div id="signer-lastSyncBlock" class="value">‚Äî</div>
            <div class="label">Last Block</div>
          </div>
          <div class="trust-stat">
            <div id="signer-verifiedCount" class="value">‚Äî</div>
            <div class="label">Verified</div>
          </div>
          <div class="trust-stat">
            <div id="signer-totalPublishers" class="value">‚Äî</div>
            <div class="label">Total</div>
          </div>
        </div>

        <span class="section-label">Publishers</span>
        <div id="signer-publisherList" class="publisher-list">
          <div class="publisher-row">
            <span class="publisher-id">Loading...</span>
          </div>
        </div>

        <div style="margin-top: var(--pad-lg);">
          <button id="signer-refreshTrustBtn" class="btn">Refresh Trust State</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    (function() {
      const $ = (id) => document.getElementById('signer-' + id);
      
      // ==================== TILE VISIBILITY SYSTEM ====================
      const MODULE_ID = 'bls_tls_signer_v1';
      const STORAGE_KEY = `cryfttee_hidden_tiles_${MODULE_ID}`;
      
      function getHiddenTiles() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        } catch { return []; }
      }
      
      function setHiddenTiles(tiles) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tiles));
      }
      
      function updateTileVisibility() {
        const hidden = getHiddenTiles();
        const cards = document.querySelectorAll('.card[data-tile-id]');
        
        cards.forEach(card => {
          const tileId = card.dataset.tileId;
          if (hidden.includes(tileId)) {
            card.classList.add('tile-hidden');
          } else {
            card.classList.remove('tile-hidden');
          }
        });
        
        // Update toolbar
        const listEl = document.getElementById('hidden-tiles-list');
        const showAllBtn = document.getElementById('show-all-btn');
        
        showAllBtn.style.display = hidden.length > 0 ? 'inline-block' : 'none';
        
        // Show chips for hidden tiles
        listEl.innerHTML = '';
        hidden.forEach(tileId => {
          const card = document.querySelector(`.card[data-tile-id="${tileId}"]`);
          const tileName = card?.dataset.tileName || tileId;
          const chip = document.createElement('span');
          chip.className = 'hidden-tile-chip';
          chip.innerHTML = `<span class="restore-icon">+</span>${tileName}`;
          chip.title = `Click to show "${tileName}"`;
          chip.addEventListener('click', () => showTile(tileId));
          listEl.appendChild(chip);
        });
      }
      
      function hideTile(tileId) {
        const hidden = getHiddenTiles();
        if (!hidden.includes(tileId)) {
          hidden.push(tileId);
          setHiddenTiles(hidden);
          updateTileVisibility();
        }
      }
      
      function showTile(tileId) {
        const hidden = getHiddenTiles();
        const idx = hidden.indexOf(tileId);
        if (idx > -1) {
          hidden.splice(idx, 1);
          setHiddenTiles(hidden);
          updateTileVisibility();
        }
      }
      
      function showAllTiles() {
        setHiddenTiles([]);
        updateTileVisibility();
      }
      
      function resetLayout() {
        if (confirm('Reset tile layout to default? This will show all hidden tiles.')) {
          showAllTiles();
        }
      }
      
      // Initialize tile visibility system
      function initTileVisibility() {
        // Add click handlers to hide buttons
        document.querySelectorAll('.tile-hide-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.card');
            const tileId = card?.dataset.tileId;
            if (tileId) hideTile(tileId);
          });
        });
        
        // Toolbar buttons
        document.getElementById('show-all-btn')?.addEventListener('click', showAllTiles);
        document.getElementById('reset-layout-btn')?.addEventListener('click', resetLayout);
        
        // Apply saved visibility
        updateTileVisibility();
      }
      
      // Initialize on DOM ready
      initTileVisibility();
      // ==================== END TILE VISIBILITY ====================

      async function fetchStatus() {
        try {
          const res = await fetch('/api/modules');
          const data = await res.json();
          const mod = (data.modules || []).find(m => m.id === 'bls_tls_signer_v1');
          if (mod) {
            $('infoVersion').textContent = mod.version || '‚Äî';
            $('infoStatus').textContent = mod.status || '‚Äî';
            $('infoCaps').textContent = (mod.capabilities || []).join(', ') || '‚Äî';
            const badge = $('statusBadge');
            const isActive = mod.status === 'active';
            badge.innerHTML = '<span class="dot ' + (isActive ? 'ok' : 'warn') + '"></span>' + (isActive ? 'Ready' : 'Inactive');
            badge.className = 'badge ' + (isActive ? 'ok' : 'warn');
          }

          const list = $('moduleList');
          list.innerHTML = '';
          (data.modules || []).forEach(m => {
            const chip = document.createElement('span');
            const isActive = m.status === 'active';
            chip.className = 'chip' + (isActive ? '' : ' inactive');
            chip.innerHTML = '<span class="dot ' + (isActive ? 'ok' : 'pending') + '"></span>' + m.id;
            list.appendChild(chip);
          });
        } catch (e) {
          console.error('Failed to fetch module status:', e);
        }
      }

      async function fetchTrustState() {
        try {
          const res = await fetch('/v1/staking/status');
          if (!res.ok) throw new Error('Status endpoint unavailable');
          const data = await res.json();

          const chain = data.chain_id || 'ethereum-mainnet';
          const lastBlock = data.last_sync_block || '‚Äî';
          const publishers = data.publishers || [];

          $('chainId').textContent = chain;
          $('lastSyncBlock').textContent = lastBlock;
          $('verifiedCount').textContent = publishers.filter(p => p.verified).length || '0';
          $('totalPublishers').textContent = publishers.length || '0';

          const sel = $('publisherSelect');
          sel.innerHTML = '<option value="">Select publisher...</option>';
          publishers.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.id + (p.verified ? ' ‚úì' : '');
            sel.appendChild(opt);
          });

          const list = $('publisherList');
          if (publishers.length === 0) {
            list.innerHTML = '<div class="publisher-row"><span class="publisher-id" style="color:var(--text-dim);">No publishers configured</span></div>';
          } else {
            list.innerHTML = '';
            publishers.forEach(p => {
              const row = document.createElement('div');
              row.className = 'publisher-row';
              row.innerHTML = '<span class="publisher-id">' + p.id + '</span><span class="pub-status ' + (p.verified ? 'verified' : 'pending') + '">' + (p.verified ? 'Verified' : 'Pending') + '</span>';
              list.appendChild(row);
            });
          }
        } catch (e) {
          console.error('Failed to fetch trust state:', e);
          $('chainId').textContent = '‚Äî';
          $('lastSyncBlock').textContent = '‚Äî';
          $('verifiedCount').textContent = '‚Äî';
          $('totalPublishers').textContent = '‚Äî';
          $('publisherList').innerHTML = '<div class="publisher-row"><span class="publisher-id" style="color:var(--bad);">Error loading</span></div>';
        }
      }

      $('prepareBtn').addEventListener('click', async () => {
        const output = $('signOutput');
        const msg = document.getElementById('signer-messageInput').value.trim();
        if (!msg) {
          output.className = 'output error';
          output.textContent = 'Error: Please enter a message.';
          return;
        }
        output.className = 'output';
        output.textContent = 'Preparing...\n\nHash: 0x' + Array.from(crypto.getRandomValues(new Uint8Array(32))).map(b => b.toString(16).padStart(2, '0')).join('');
        $('signBtn').disabled = false;
      });

      $('signBtn').addEventListener('click', async () => {
        const output = $('signOutput');
        const keyHandle = $('keyHandle').value.trim();
        output.className = 'output';
        output.textContent += '\n\nSigning with key: ' + (keyHandle || 'default') + '...';
        
        try {
          await new Promise(r => setTimeout(r, 400));
          const sig = '0x' + Array.from(crypto.getRandomValues(new Uint8Array(96))).map(b => b.toString(16).padStart(2, '0')).join('');
          output.className = 'output success';
          output.textContent += '\n\n‚úì Signature:\n' + sig;
          $('applyBtn').disabled = false;
        } catch (e) {
          output.className = 'output error';
          output.textContent += '\n\n‚úó Failed: ' + e.message;
        }
      });

      $('applyBtn').addEventListener('click', async () => {
        const output = $('signOutput');
        output.textContent += '\n\nApplying to chain...';
        await new Promise(r => setTimeout(r, 600));
        output.textContent += '\n‚úì Transaction submitted.';
      });

      // Key action selector
      $('keyAction').addEventListener('change', () => {
        const action = $('keyAction').value;
        $('verifyKeySection').style.display = action === 'verify' ? 'block' : 'none';
      });

      // Key action button
      $('keyActionBtn').addEventListener('click', async () => {
        const output = $('keyOutput');
        const mode = $('keyMode').value;
        const action = $('keyAction').value;
        
        output.className = 'output';

        if (action === 'verify') {
          const pubkey = $('verifyPubkey').value.trim();
          if (!pubkey) {
            output.className = 'output error';
            output.textContent = '‚úó Please enter a public key to verify.';
            return;
          }
          output.textContent = 'Verifying ' + mode.toUpperCase() + ' key exists in Web3Signer...\n';
          
          try {
            const endpoint = mode === 'bls' ? '/v1/staking/bls/register' : '/v1/staking/tls/register';
            const res = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ mode: 'verify', publicKey: pubkey })
            });
            
            if (res.status === 404) {
              output.className = 'output error';
              output.textContent += '\n‚úó Key NOT FOUND in Web3Signer.\n\nYou need to generate and import this key first.\nSee the "Key Generation Guide" card below.';
            } else if (res.ok) {
              const data = await res.json();
              output.className = 'output success';
              output.textContent += '\n‚úì Key VERIFIED in Web3Signer.\n\nKey Handle: ' + (data.key_handle || data.keyHandle || pubkey);
            } else {
              const err = await res.text();
              output.className = 'output error';
              output.textContent += '\n‚úó Error: ' + err;
            }
          } catch (e) {
            output.className = 'output error';
            output.textContent += '\n‚úó Request failed: ' + e.message;
          }

        } else if (action === 'list') {
          output.textContent = 'Fetching ' + mode.toUpperCase() + ' keys from Web3Signer...\n';
          
          try {
            const endpoint = mode === 'bls' ? '/v1/staking/bls/register' : '/v1/staking/tls/register';
            const res = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ mode: 'persistent' })
            });
            
            if (res.ok) {
              const data = await res.json();
              output.className = 'output success';
              output.textContent += '\n‚úì Found key:\n\nPublic Key: ' + (data.public_key || data.publicKey || data.key_handle || '‚Äî');
            } else if (res.status === 404) {
              output.className = 'output warn';
              output.textContent += '\n‚ö† No keys found in Web3Signer.\n\nGenerate and import keys first.';
            } else {
              const err = await res.text();
              output.className = 'output error';
              output.textContent += '\n‚úó Error: ' + err;
            }
          } catch (e) {
            output.className = 'output error';
            output.textContent += '\n‚úó Request failed: ' + e.message;
          }

        } else if (action === 'generate-instructions') {
          output.className = 'output';
          if (mode === 'bls') {
            output.textContent = 'BLS Key Generation Options:\n\n' +
              '1. eth2.0-deposit-cli:\n' +
              '   pip install eth2-deposit-cli\n' +
              '   eth2_deposit_cli new-mnemonic --num_validators 1\n\n' +
              '2. Teku (Docker):\n' +
              '   docker run --rm -v $(pwd)/keys:/keys \\\n' +
              '     consensys/teku:latest validator generate-keys \\\n' +
              '     --output-path=/keys --keys-count=1\n\n' +
              'Then import keystore to Web3Signer.\nSee README.md for full instructions.';
          } else {
            output.textContent = 'TLS Key Generation (OpenSSL):\n\n' +
              '# Generate ECDSA P-256 key\n' +
              'openssl ecparam -name prime256v1 -genkey -noout \\\n' +
              '  -out tls-private.pem\n\n' +
              '# Export public key\n' +
              'openssl ec -in tls-private.pem -pubout \\\n' +
              '  -out tls-public.pem\n\n' +
              '# Convert to PKCS#8 for Web3Signer\n' +
              'openssl pkcs8 -topk8 -nocrypt \\\n' +
              '  -in tls-private.pem -out tls-private.pkcs8.pem\n\n' +
              'Then import to Web3Signer keys directory.';
          }
        }
      });

      // Key generation guide
      const guides = {
        bls: {
          file: `# BLS Key Generation & Import (File-based)

## Step 1: Generate BLS Keys
# Option A: Using eth2.0-deposit-cli
pip install eth2-deposit-cli
eth2_deposit_cli new-mnemonic --num_validators 1 --chain mainnet

# Option B: Using Teku (Docker)
echo "your-password" > password.txt
docker run --rm -v $(pwd):/keys consensys/teku:latest \\
  validator generate-keys \\
  --output-path=/keys --keys-count=1 \\
  --encrypted-keystore-enabled=true \\
  --keystore-password-file=/keys/password.txt

## Step 2: Import to Web3Signer
# Copy keystore to Web3Signer directory
cp keystore-*.json /opt/web3signer/keys/

# Create password file (same name with .txt)
cp password.txt /opt/web3signer/keys/keystore-m_XXX.txt

# Restart Web3Signer
sudo systemctl restart web3signer

## Step 3: Verify in CryftTEE
# Use "Verify Existing Key" with your public key`,
          vault: `# BLS Key Generation & Import (HashiCorp Vault)

## Step 1: Generate BLS Keys (same as file-based)
pip install eth2-deposit-cli
eth2_deposit_cli new-mnemonic --num_validators 1 --chain mainnet

## Step 2: Store in HashiCorp Vault
# Enable KV secrets engine
vault secrets enable -path=web3signer kv-v2

# Store the private key (extract from keystore first)
vault kv put web3signer/bls/validator-1 \\
  private_key="0xYOUR_PRIVATE_KEY_HEX" \\
  public_key="0xYOUR_PUBLIC_KEY_HEX"

## Step 3: Configure Web3Signer for Vault
# Create vault key config: /etc/web3signer/keys/validator-1.yaml
cat > validator-1.yaml << EOF
type: hashicorp
keyType: BLS
tlsEnabled: true
keyPath: /v1/secret/data/web3signer/bls/validator-1
token: \${VAULT_TOKEN}
serverHost: vault.example.com
serverPort: 8200
EOF

## Step 4: Start Web3Signer
export VAULT_TOKEN="hvs.xxxxx"
web3signer --http-listen-port=9000 eth2 \\
  --network=mainnet --key-config-path=/etc/web3signer/keys/`
        },
        tls: {
          file: `# TLS Key Generation & Import (File-based)

## Step 1: Generate ECDSA P-256 Key
openssl ecparam -name prime256v1 -genkey -noout \\
  -out tls-private.pem

## Step 2: Export Public Key
openssl ec -in tls-private.pem -pubout -out tls-public.pem

## Step 3: Convert to PKCS#8 (Web3Signer format)
openssl pkcs8 -topk8 -nocrypt \\
  -in tls-private.pem -out tls-private.pkcs8.pem

## Step 4: Generate Certificate (optional)
openssl req -new -x509 -key tls-private.pem \\
  -out tls-cert.pem -days 365 \\
  -subj "/CN=cryfttee-node/O=CryftLabs"

## Step 5: Import to Web3Signer
# Create key config: /opt/web3signer/keys/tls-node-1.yaml
cat > tls-node-1.yaml << EOF
type: file-raw
keyType: SECP256K1
privateKeyFile: /opt/web3signer/keys/tls-private.pkcs8.pem
EOF

# Copy files and restart
cp tls-private.pkcs8.pem /opt/web3signer/keys/
sudo systemctl restart web3signer`,
          vault: `# TLS Key Generation & Import (HashiCorp Vault)

## Step 1: Generate ECDSA Key
openssl ecparam -name prime256v1 -genkey -noout \\
  -out tls-private.pem
openssl ec -in tls-private.pem -pubout -out tls-public.pem

## Step 2: Store in HashiCorp Vault
vault kv put web3signer/tls/node-1 \\
  private_key="$(cat tls-private.pem)" \\
  public_key="$(cat tls-public.pem)"

## Step 3: Configure Web3Signer for Vault
cat > tls-node-1.yaml << EOF
type: hashicorp
keyType: SECP256K1
tlsEnabled: true
keyPath: /v1/secret/data/web3signer/tls/node-1
token: \${VAULT_TOKEN}
serverHost: vault.example.com
serverPort: 8200
EOF

## Step 4: Start Web3Signer
export VAULT_TOKEN="hvs.xxxxx"
web3signer --http-listen-port=9000 eth1 \\
  --key-config-path=/etc/web3signer/keys/`
        }
      };

      function updateGuide() {
        const keyType = $('keyMode').value;
        const backend = $('storageBackend').value;
        const guide = guides[keyType][backend];
        
        $('guideContent').innerHTML = '<pre class="output" style="max-height: 280px; white-space: pre-wrap;">' + guide + '</pre>';
      }

      $('keyMode').addEventListener('change', updateGuide);
      $('storageBackend').addEventListener('change', updateGuide);
      
      $('copyGuideBtn').addEventListener('click', () => {
        const keyType = $('keyMode').value;
        const backend = $('storageBackend').value;
        const guide = guides[keyType][backend];
        navigator.clipboard.writeText(guide).then(() => {
          $('copyGuideBtn').textContent = '‚úì Copied!';
          setTimeout(() => { $('copyGuideBtn').textContent = 'Copy Commands'; }, 2000);
        });
      });

      // Initialize guide
      updateGuide();

      $('refreshTrustBtn').addEventListener('click', fetchTrustState);

      // ==================== MODULE SIGNING ====================
      
      let moduleSigningKey = null;
      let lastSignature = null;
      
      async function callModule(operation, params) {
        const res = await fetch('/v1/module/bls_tls_signer_v1/call', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ operation, ...params })
        });
        return res.json();
      }
      
      async function checkModuleSigningKey() {
        try {
          const res = await callModule('module_signing_key', { action: 'list' });
          if (res.keys && res.keys.length > 0) {
            moduleSigningKey = res.keys[0];
            $('moduleKeyId').textContent = moduleSigningKey.key_id;
            $('moduleKeyType').textContent = moduleSigningKey.key_type;
            $('moduleKeyPubkey').textContent = moduleSigningKey.public_key.substring(0, 24) + '...';
            $('moduleSignBadge').innerHTML = '<span class="dot ok"></span>Key Ready';
            $('moduleSignBadge').className = 'badge ok';
            $('exportModuleKeyBtn').disabled = false;
            $('signModuleBtn').disabled = false;
          } else {
            moduleSigningKey = null;
            $('moduleKeyId').textContent = '‚Äî';
            $('moduleKeyType').textContent = '‚Äî';
            $('moduleKeyPubkey').textContent = '‚Äî';
            $('moduleSignBadge').innerHTML = '<span class="dot pending"></span>No Key';
            $('moduleSignBadge').className = 'badge';
            $('exportModuleKeyBtn').disabled = true;
            $('signModuleBtn').disabled = true;
          }
        } catch (e) {
          console.error('Failed to check module signing key:', e);
        }
      }
      
      $('genModuleKeyBtn').addEventListener('click', async () => {
        const output = $('moduleSignOutput');
        output.className = 'output';
        output.textContent = 'Generating Ed25519 key pair...';
        
        try {
          const res = await callModule('module_signing_key', {
            action: 'generate',
            key_id: 'default',
            key_type: 'ed25519'
          });
          
          if (res.success || res.pending) {
            output.className = 'output success';
            output.textContent = '‚úì Key generation requested.\n\n' + JSON.stringify(res, null, 2);
            await checkModuleSigningKey();
          } else {
            output.className = 'output error';
            output.textContent = '‚úó ' + (res.error || 'Key generation failed');
          }
        } catch (e) {
          output.className = 'output error';
          output.textContent = '‚úó Request failed: ' + e.message;
        }
      });
      
      $('importModuleKeyBtn').addEventListener('click', async () => {
        const privateKey = prompt('Enter Ed25519 private key (hex):');
        if (!privateKey) return;
        
        const output = $('moduleSignOutput');
        output.className = 'output';
        output.textContent = 'Importing key...';
        
        try {
          const res = await callModule('module_signing_key', {
            action: 'import',
            key_id: 'default',
            key_type: 'ed25519',
            private_key: privateKey
          });
          
          if (res.success || res.pending) {
            output.className = 'output success';
            output.textContent = '‚úì Key import requested.\n\n' + JSON.stringify(res, null, 2);
            await checkModuleSigningKey();
          } else {
            output.className = 'output error';
            output.textContent = '‚úó ' + (res.error || 'Key import failed');
          }
        } catch (e) {
          output.className = 'output error';
          output.textContent = '‚úó Request failed: ' + e.message;
        }
      });
      
      $('exportModuleKeyBtn').addEventListener('click', async () => {
        const output = $('moduleSignOutput');
        output.className = 'output';
        output.textContent = 'Exporting public key...';
        
        try {
          const res = await callModule('module_signing_key', {
            action: 'export_pubkey',
            key_id: 'default'
          });
          
          output.className = 'output success';
          output.textContent = '‚úì Public Key:\n\n' + (res.public_key || moduleSigningKey?.public_key || '‚Äî');
          
          navigator.clipboard.writeText(res.public_key || moduleSigningKey?.public_key || '');
          output.textContent += '\n\n(Copied to clipboard)';
        } catch (e) {
          output.className = 'output error';
          output.textContent = '‚úó Request failed: ' + e.message;
        }
      });
      
      $('hashModuleBtn').addEventListener('click', async () => {
        const wasmPath = $('moduleWasmPath').value.trim();
        const output = $('moduleSignOutput');
        
        if (!wasmPath) {
          output.className = 'output error';
          output.textContent = '‚úó Please enter a WASM file path.';
          return;
        }
        
        // Check if it's already a hash (64 hex chars)
        if (/^[a-fA-F0-9]{64}$/.test(wasmPath)) {
          output.className = 'output success';
          output.textContent = '‚úì Using provided hash:\n\n' + wasmPath.toLowerCase();
          $('signModuleBtn').disabled = !moduleSigningKey;
          return;
        }
        
        output.className = 'output';
        output.textContent = 'Computing SHA256 hash...';
        
        try {
          const res = await callModule('hash_module', {
            wasm_path: wasmPath
          });
          
          if (res.hash || res.pending) {
            output.className = 'output success';
            output.textContent = '‚úì WASM Hash:\n\n' + (res.hash || 'pending') + '\n\nSize: ' + (res.size || '?') + ' bytes';
            if (res.hash) {
              $('moduleWasmPath').value = res.hash;
            }
            $('signModuleBtn').disabled = !moduleSigningKey;
          } else {
            output.className = 'output error';
            output.textContent = '‚úó ' + (res.error || 'Hash computation failed');
          }
        } catch (e) {
          output.className = 'output error';
          output.textContent = '‚úó Request failed: ' + e.message;
        }
      });
      
      $('signModuleBtn').addEventListener('click', async () => {
        const wasmHash = $('moduleWasmPath').value.trim();
        const moduleId = $('moduleId').value.trim();
        const version = $('moduleVersion').value.trim();
        const publisherId = $('publisherId').value.trim();
        const output = $('moduleSignOutput');
        
        if (!wasmHash || !moduleId || !version || !publisherId) {
          output.className = 'output error';
          output.textContent = '‚úó Please fill in all fields.';
          return;
        }
        
        if (!/^[a-fA-F0-9]{64}$/.test(wasmHash)) {
          output.className = 'output error';
          output.textContent = '‚úó WASM hash must be 64-character hex. Click "Hash WASM" first.';
          return;
        }
        
        output.className = 'output';
        output.textContent = 'Signing module...';
        
        try {
          const res = await callModule('sign_module', {
            key_id: 'default',
            wasm_hash: wasmHash,
            module_id: moduleId,
            version: version,
            publisher_id: publisherId
          });
          
          if (res.signature || res.pending) {
            lastSignature = res.signature;
            output.className = 'output success';
            output.textContent = '‚úì Module Signed!\n\n';
            output.textContent += 'Signature:\n' + (res.signature || 'pending') + '\n\n';
            output.textContent += 'Public Key:\n' + (res.public_key || moduleSigningKey?.public_key || '‚Äî') + '\n\n';
            if (res.canonical_payload) {
              output.textContent += 'Signed Payload:\n' + JSON.stringify(res.canonical_payload, null, 2);
            }
            $('copySignatureBtn').disabled = false;
          } else {
            output.className = 'output error';
            output.textContent = '‚úó ' + (res.error || 'Signing failed');
          }
        } catch (e) {
          output.className = 'output error';
          output.textContent = '‚úó Request failed: ' + e.message;
        }
      });
      
      $('copySignatureBtn').addEventListener('click', () => {
        if (lastSignature) {
          navigator.clipboard.writeText(lastSignature);
          const btn = $('copySignatureBtn');
          btn.textContent = '‚úì Copied!';
          setTimeout(() => { btn.textContent = 'Copy Signature'; }, 2000);
        }
      });
      
      // Verify Module
      $('verifyModuleBtn').addEventListener('click', async () => {
        const wasmHash = $('verifyWasmHash').value.trim();
        const moduleId = $('verifyModuleId').value.trim();
        const version = $('verifyVersion').value.trim();
        const publisherId = $('verifyPublisherId').value.trim();
        const publicKey = $('verifyPublicKey').value.trim();
        const signature = $('verifySignature').value.trim();
        const output = $('verifyModuleOutput');
        
        if (!wasmHash || !moduleId || !version || !publisherId || !publicKey || !signature) {
          output.className = 'output error';
          output.textContent = '‚úó Please fill in all fields.';
          return;
        }
        
        output.className = 'output';
        output.textContent = 'Verifying signature...';
        
        try {
          const res = await callModule('verify_module', {
            wasm_hash: wasmHash,
            module_id: moduleId,
            version: version,
            publisher_id: publisherId,
            public_key: publicKey,
            signature: signature
          });
          
          if (res.valid) {
            output.className = 'output success';
            output.textContent = '‚úì SIGNATURE VALID\n\nThis module was signed by the specified publisher.';
          } else if (res.valid === false) {
            output.className = 'output error';
            output.textContent = '‚úó SIGNATURE INVALID\n\nThe signature does not match the module metadata.';
          } else {
            output.className = 'output';
            output.textContent = 'Verification request sent.\n\n' + JSON.stringify(res, null, 2);
          }
        } catch (e) {
          output.className = 'output error';
          output.textContent = '‚úó Request failed: ' + e.message;
        }
      });
      
      $('loadFromManifestBtn').addEventListener('click', async () => {
        const output = $('verifyModuleOutput');
        output.className = 'output';
        output.textContent = 'Loading modules from manifest...';
        
        try {
          const res = await fetch('/api/modules');
          const data = await res.json();
          
          if (!data.modules || data.modules.length === 0) {
            output.textContent = 'No modules found in manifest.';
            return;
          }
          
          // Show module selector
          let html = 'Select a module to verify:\n\n';
          data.modules.forEach((m, i) => {
            html += `${i + 1}. ${m.id} v${m.version} (${m.publisherId || 'unknown'})\n`;
          });
          output.textContent = html;
          
          const choice = prompt('Enter module number (1-' + data.modules.length + '):');
          const idx = parseInt(choice) - 1;
          if (idx >= 0 && idx < data.modules.length) {
            const m = data.modules[idx];
            $('verifyWasmHash').value = (m.hash || '').replace('sha256:', '');
            $('verifyModuleId').value = m.id || '';
            $('verifyVersion').value = m.version || '';
            $('verifyPublisherId').value = m.publisherId || '';
            $('verifySignature').value = m.signature || '';
            output.textContent = 'Loaded: ' + m.id + '\n\nEnter the publisher public key to verify.';
          }
        } catch (e) {
          output.className = 'output error';
          output.textContent = '‚úó Failed to load manifest: ' + e.message;
        }
      });
      
      // Check for existing signing key on load
      checkModuleSigningKey();
      
      // ==================== END MODULE SIGNING ====================

      fetchStatus();
      fetchTrustState();
      setInterval(fetchStatus, 10000);
    })();
  </script>
</body>
</html>
