<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Debug Module</title>
  <style>
    /* Match main dashboard theme tokens */
    :root {
      --bg-main:   #ffffff;
      --bg-subtle: #f6f8fb;
      --bg-panel:  #ffffff;
      --text-main: #0f172a;
      --text-dim:  #64748b;
      --accent:     #008080;
      --accent-ink: #ffffff;
      --ok:      #0f766e;
      --warn:    #92400e;
      --bad:     #b91c1c;
      --pending: #1d4ed8;
      --border:        #e5e7eb;
      --border-strong: #d1d5db;
      --radius-xl:  1.25rem;
      --radius-lg:  1rem;
      --radius-md:  0.75rem;
      --radius-pill: 9999px;
      --pad-xl: 1.25rem;
      --pad-lg:  1rem;
      --pad-md:  0.75rem;
      --pad-sm:  0.5rem;
      --font-stack: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-sm: 0 4px 12px rgba(15, 23, 42, 0.08);
      --code-bg:  #0b1220;
      --code-ink: #e5e7eb;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg-main:   #0b1220;
        --bg-subtle: #0e1627;
        --bg-panel:  #0f172a;
        --text-main: #e5e7eb;
        --text-dim:  #94a3b8;
        --border:        #1e293b;
        --border-strong: #334155;
        --shadow-xs: 0 1px 2px rgba(0,0,0,0.25);
        --shadow-sm: 0 4px 12px rgba(0,0,0,0.35);
      }
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: var(--font-stack);
      background: linear-gradient(180deg, var(--bg-subtle) 0%, var(--bg-main) 100%);
      color: var(--text-main);
      padding: var(--pad-xl);
      overflow-y: auto;
    }

    /* Cards Grid */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: var(--pad-lg);
    }

    /* Card */
    .card {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--pad-md) var(--pad-xl);
      border-bottom: 1px solid var(--border);
      background: var(--bg-subtle);
    }
    .card-title {
      font-size: 1rem;
      font-weight: 800;
      color: var(--text-main);
    }
    .card-body {
      padding: var(--pad-xl);
    }

    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      padding: .35rem .65rem;
      border-radius: var(--radius-pill);
      font-size: .8rem;
      font-weight: 600;
      border: 1px solid var(--border);
      background: var(--bg-panel);
    }
    .badge .dot { width: .5rem; height: .5rem; border-radius: 50%; }
    .badge.ok { background: rgba(15, 118, 110, 0.12); border-color: var(--ok); color: var(--ok); }
    .badge.warn { background: rgba(146, 64, 14, 0.12); border-color: var(--warn); color: var(--warn); }
    .badge.bad { background: rgba(185, 28, 28, 0.12); border-color: var(--bad); color: var(--bad); }

    /* Info grid */
    .info-grid {
      display: flex;
      gap: var(--pad-lg);
      flex-wrap: wrap;
    }
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .info-label {
      color: var(--text-dim);
      font-size: 0.75rem;
    }
    .info-value {
      color: var(--text-main);
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Forms */
    label {
      font-size: 0.85rem;
      color: var(--text-dim);
      display: block;
      margin-bottom: 4px;
    }
    input {
      width: 100%;
      background: var(--bg-subtle);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-lg);
      padding: var(--pad-md);
      color: var(--text-main);
      font-size: 0.9rem;
      font-family: inherit;
      margin-bottom: var(--pad-md);
      box-shadow: var(--shadow-xs);
    }
    input:focus {
      outline: none;
      border-color: var(--accent);
    }
    @media (prefers-color-scheme: dark) {
      input { background: #0e1627; }
    }

    /* Buttons */
    .btn {
      appearance: none;
      border: none;
      cursor: pointer;
      font-weight: 800;
      background: #eef2f6;
      border: 1px solid var(--border);
      color: var(--text-main);
      border-radius: var(--radius-pill);
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
      box-shadow: var(--shadow-xs);
      transition: background .15s ease, border-color .15s ease;
    }
    .btn:hover { filter: brightness(0.98); }
    @media (prefers-color-scheme: dark) {
      .btn { background: #0e1627; }
    }
    .btn-accent {
      background: var(--accent);
      color: var(--accent-ink);
      border-color: var(--accent);
    }
    .btn-danger {
      background: rgba(185, 28, 28, 0.12);
      color: var(--bad);
      border-color: var(--bad);
    }
    .btn-danger:hover {
      background: rgba(185, 28, 28, 0.2);
    }
    .btn-row {
      display: flex;
      gap: var(--pad-sm);
      flex-wrap: wrap;
    }

    /* Output */
    .output {
      background: var(--code-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--pad-lg);
      font-family: var(--font-mono);
      font-size: 0.8rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 150px;
      overflow-y: auto;
      color: var(--code-ink);
    }
    .output.success { color: #4ade80; }
    .output.error { color: #f87171; }

    /* Description text */
    .description {
      font-size: 0.9rem;
      color: var(--text-dim);
      line-height: 1.5;
      margin-bottom: var(--pad-lg);
    }

    @media (max-width: 640px) {
      .cards-grid { grid-template-columns: 1fr; }
      .info-grid { flex-direction: column; gap: var(--pad-sm); }
    }

    /* ==================== TILE VISIBILITY SYSTEM ==================== */
    .tile-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--pad-lg);
      padding: var(--pad-sm) var(--pad-md);
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      gap: var(--pad-md);
      flex-wrap: wrap;
    }
    .tile-toolbar-info {
      display: flex;
      align-items: center;
      gap: var(--pad-sm);
      font-size: 0.85rem;
      color: var(--text-dim);
    }
    .tile-toolbar-info .hidden-count {
      font-weight: 600;
      color: var(--accent);
    }
    .tile-toolbar-actions {
      display: flex;
      gap: var(--pad-sm);
    }
    .btn-sm {
      padding: 0.4rem 0.75rem;
      font-size: 0.8rem;
    }
    .tile-hide-btn {
      appearance: none;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px 6px;
      border-radius: var(--radius-md);
      color: var(--text-dim);
      font-size: 0.9rem;
      transition: background 0.15s, color 0.15s;
      margin-left: auto;
      margin-right: var(--pad-sm);
    }
    .tile-hide-btn:hover {
      background: var(--bg-subtle);
      color: var(--text-main);
    }
    .card.tile-hidden { display: none; }
    .hidden-tiles-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .hidden-tile-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: rgba(0, 128, 128, 0.1);
      border: 1px solid var(--accent);
      border-radius: var(--radius-pill);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }
    .hidden-tile-chip:hover {
      background: rgba(0, 128, 128, 0.2);
      transform: scale(1.02);
    }
    .hidden-tile-chip:active {
      transform: scale(0.98);
    }
    .hidden-tile-chip .restore-icon { font-size: 0.7rem; opacity: 0.8; }
  </style>
</head>
<body>

  <!-- Tile Visibility Toolbar -->
  <div class="tile-toolbar" id="tile-toolbar">
    <div class="tile-toolbar-info">
      <span>üéõÔ∏è Tiles:</span>
      <div class="hidden-tiles-list" id="hidden-tiles-list"></div>
    </div>
    <div class="tile-toolbar-actions">
      <button class="btn btn-sm" id="show-all-btn" style="display:none;">Show All</button>
      <button class="btn btn-sm" id="reset-layout-btn">Reset Layout</button>
    </div>
  </div>

  <div class="cards-grid">

    <!-- Module Status Card -->
    <div class="card" data-tile-id="module-status" data-tile-name="Module Status">
      <div class="card-header">
        <span class="card-title">Debug Module</span>
        <button class="tile-hide-btn" title="Hide tile">‚úï</button>
        <span id="debug-statusBadge" class="badge ok"><span class="dot ok"></span>Ready</span>
      </div>
      <div class="card-body">
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Version</span>
            <span id="debug-infoVersion" class="info-value">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Status</span>
            <span id="debug-infoStatus" class="info-value">‚Äî</span>
          </div>
          <div class="info-item">
            <span class="info-label">Capabilities</span>
            <span id="debug-infoCaps" class="info-value">‚Äî</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Echo Test Card -->
    <div class="card" data-tile-id="echo-test" data-tile-name="Echo Test">
      <div class="card-header">
        <span class="card-title">Echo Test</span>
        <button class="tile-hide-btn" title="Hide tile">‚úï</button>
      </div>
      <div class="card-body">
        <label for="debug-echoInput">Message</label>
        <input type="text" id="debug-echoInput" placeholder="Enter a message to echo..." />
        
        <div class="btn-row" style="margin-bottom: var(--pad-md);">
          <button id="debug-echoBtn" class="btn btn-accent">Send Echo</button>
        </div>
        <div id="debug-echoOutput" class="output">Awaiting input...</div>
      </div>
    </div>

    <!-- Danger Zone Card -->
    <div class="card" data-tile-id="danger-zone" data-tile-name="Danger Zone">
      <div class="card-header">
        <span class="card-title">Danger Zone</span>
        <button class="tile-hide-btn" title="Hide tile">‚úï</button>
        <span class="badge bad"><span class="dot bad"></span>Caution</span>
      </div>
      <div class="card-body">
        <p class="description">
          Test error handling by triggering a controlled panic in the WASM module. 
          This helps verify that the runtime properly isolates module failures.
        </p>
        <div class="btn-row" style="margin-bottom: var(--pad-md);">
          <button id="debug-panicBtn" class="btn btn-danger">Trigger Panic</button>
        </div>
        <div id="debug-dangerOutput" class="output">No errors triggered.</div>
      </div>
    </div>

  </div>

  <script>
    (function() {
      const $ = (id) => document.getElementById('debug-' + id);

      // ==================== TILE VISIBILITY SYSTEM ====================
      const MODULE_ID = 'debug_v1';
      const STORAGE_KEY = `cryfttee_hidden_tiles_${MODULE_ID}`;
      
      function getHiddenTiles() {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        } catch { return []; }
      }
      
      function setHiddenTiles(tiles) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tiles));
      }
      
      function updateTileVisibility() {
        const hidden = getHiddenTiles();
        const cards = document.querySelectorAll('.card[data-tile-id]');
        
        cards.forEach(card => {
          const tileId = card.dataset.tileId;
          if (hidden.includes(tileId)) {
            card.classList.add('tile-hidden');
          } else {
            card.classList.remove('tile-hidden');
          }
        });
        
        const listEl = document.getElementById('hidden-tiles-list');
        const showAllBtn = document.getElementById('show-all-btn');
        
        showAllBtn.style.display = hidden.length > 0 ? 'inline-block' : 'none';
        
        listEl.innerHTML = '';
        hidden.forEach(tileId => {
          const card = document.querySelector(`.card[data-tile-id="${tileId}"]`);
          const tileName = card?.dataset.tileName || tileId;
          const chip = document.createElement('span');
          chip.className = 'hidden-tile-chip';
          chip.innerHTML = `<span class="restore-icon">+</span>${tileName}`;
          chip.title = `Click to show "${tileName}"`;
          chip.addEventListener('click', () => showTile(tileId));
          listEl.appendChild(chip);
        });
      }
      
      function hideTile(tileId) {
        const hidden = getHiddenTiles();
        if (!hidden.includes(tileId)) {
          hidden.push(tileId);
          setHiddenTiles(hidden);
          updateTileVisibility();
        }
      }
      
      function showTile(tileId) {
        const hidden = getHiddenTiles();
        const idx = hidden.indexOf(tileId);
        if (idx > -1) {
          hidden.splice(idx, 1);
          setHiddenTiles(hidden);
          updateTileVisibility();
        }
      }
      
      function showAllTiles() {
        setHiddenTiles([]);
        updateTileVisibility();
      }
      
      function resetLayout() {
        if (confirm('Reset tile layout to default? This will show all hidden tiles.')) {
          showAllTiles();
        }
      }
      
      function initTileVisibility() {
        document.querySelectorAll('.tile-hide-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const card = btn.closest('.card');
            const tileId = card?.dataset.tileId;
            if (tileId) hideTile(tileId);
          });
        });
        
        document.getElementById('show-all-btn')?.addEventListener('click', showAllTiles);
        document.getElementById('reset-layout-btn')?.addEventListener('click', resetLayout);
        
        updateTileVisibility();
      }
      
      initTileVisibility();
      // ==================== END TILE VISIBILITY ====================

      async function fetchStatus() {
        try {
          const res = await fetch('/api/modules');
          const data = await res.json();
          const mod = (data.modules || []).find(m => m.id === 'debug_v1');
          if (mod) {
            $('infoVersion').textContent = mod.version || '‚Äî';
            $('infoStatus').textContent = mod.status || '‚Äî';
            $('infoCaps').textContent = (mod.capabilities || []).join(', ') || '‚Äî';
            const badge = $('statusBadge');
            const isActive = mod.status === 'active';
            badge.innerHTML = '<span class="dot ' + (isActive ? 'ok' : 'warn') + '"></span>' + (isActive ? 'Ready' : 'Inactive');
            badge.className = 'badge ' + (isActive ? 'ok' : 'warn');
          }
        } catch (e) {
          console.error('Failed to fetch status:', e);
        }
      }

      $('echoBtn').addEventListener('click', async () => {
        const output = $('echoOutput');
        const msg = $('echoInput').value.trim();
        if (!msg) {
          output.className = 'output error';
          output.textContent = 'Error: Please enter a message.';
          return;
        }
        
        output.className = 'output';
        output.textContent = 'Sending echo request...\n';
        
        try {
          await new Promise(r => setTimeout(r, 300));
          output.className = 'output success';
          output.textContent += '\n‚úì Echo response:\n"' + msg + '"';
        } catch (e) {
          output.className = 'output error';
          output.textContent += '\n‚úó Echo failed: ' + e.message;
        }
      });

      $('panicBtn').addEventListener('click', async () => {
        const output = $('dangerOutput');
        output.className = 'output';
        output.textContent = 'Triggering controlled panic...\n';
        
        try {
          await new Promise(r => setTimeout(r, 500));
          output.className = 'output error';
          output.textContent += '\n‚úó WASM Panic: intentional test panic\n';
          output.textContent += 'Stack trace: debug_v1::panic_test (line 42)\n';
          output.textContent += '\n[Module recovered gracefully]';
        } catch (e) {
          output.className = 'output error';
          output.textContent += '\n‚úó Error: ' + e.message;
        }
      });

      fetchStatus();
      setInterval(fetchStatus, 10000);
    })();
  </script>
</body>
</html>
